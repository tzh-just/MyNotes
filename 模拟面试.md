>介绍渲染管线

应用阶段
- 视锥剔除、SOC等方法剔除视锥外的mesh、被遮挡的mesh，减少cpu向gpu提交的mesh数量
- cpu 通过读取图形API发出的DrawCall指令，推送到驱动程序，经过合法性检查，将指令放在GPU可以读取的Push Buffer中。
- cpu的drawcall太多往往是性能瓶颈。cpu可以通过批处理来减少drawcall的次数，以降低开销。例如动态合批是将同材质的mesh变换到世界空间后合并提交给gpu，适用于顶点数少的mesh；gpu instance则是把相同的mesh只提交一次，同时把每个mesh实例的变换矩阵、材质差异等送入缓冲区，在变换时把模型变换矩阵替换掉。
几何阶段
- 图元分配器会处理IndexBuffer中的顶点，以产生三角形，分批次发送给GPC同时进行处理。
- 在vertex shader中把顶点变换到-1到1的NDC空间中。经过模型变换到世界空间；经过相机变换到观察空间；经过投影变换到齐次裁剪空间。
- 在齐次裁剪空间中可以做三角形粒度的视锥剔除，对于正好在裁剪平面上的三角形可以裁剪成多个，会更准确但也更耗费性能。
- 如果光栅化时通过视口来裁剪会更简单。但如果有顶点在近平面后，透视除法会导致xy坐标翻转；如果顶点恰好在视点的平面上，那么会导致除零的错误。
- vertex shader的运算结果会被Viewport Transform模块处理，经过裁剪后准备栅格化。
光栅化阶段
- 三角形的覆盖范围决定了会被分配给哪个GPC的Raster Engine。
- Raster Engine负责接收到的三角形像素信息的生成，同时处理裁剪、背面剔除和early-z等。
- SM中的attribute setup对从顶点着色器得到的数据进行插值。
- pixel shader完成颜色和深度的计算后，将数据移交给ROP。
- 在ROP中进行深度测试和framebuffer的混合。

>什么是Radiance和Irradiance

Radiance的定义是每单位立体角每单位投影面积接收的功率。
Irradiance的定义是Radiance在半球面上对微分立体角积分，或者说是单位面积在半球面上接收四面八方的所有能量。

>介绍渲染方程

渲染方程描述了，着色点p在出射方向上的Radiance，是由物体的自发光在出射方向上的Radiance，加上入射方向上的Radiance经过BRDF在出射方向上反射色能力，在半球面上积分的综合，简单来说就是着色点接收到的四面八方的能量后再出射方向上的Radiance。

>怎么理解BRDF

从渲染方程可以看出，对两边微分可知BRDF就等于出射方向的Radiance的微分比上入射方向的Radiance。BRDF就是计算接收到半球面上四面八方的能量后，在出射方向上分布了多少能量。

>介绍Cook-Torrance BRDF

Kd·C/pi + Ks·DFG·/4cosicoso
分为漫反射项和镜面反射项。

>为什么漫反射项要除以pi

漫反射项是兰伯特模型，假定了反射方向是均匀分布在半球面上，即其BRDF是个常数。把入射Radiance和BRDF提出积分，则积分只受到入射方向的cos项影响，在半球面上积分结果为pi。根据能量守恒，1的能量经过BRDF要小于等于1，也就是BRDF=1/pi才能保证。

>介绍镜面反射项

D是法线分布函数，只有当观察方向和光源方向的半程向量符合该法线分布时才会被反射，根据粗糙度和半程向量可以计算出被反射的比例。
F是菲涅尔项，其决定视线与物体表面法线在不同角度时的光线如何反射和折射。根据F0和F90可以近似得到菲涅尔项，其中F0是观察方向与法线重合时的反射率，F90是垂直的反射率，取值都是0-1，其中F90在近似中认为是1。常见电解质的反射率为0.02到0.05，对于金属来说，F0就是金属的本色，因此可以用0.04和本色为参数以金属度为比例做插值。
G项描述的是微表面对入射方向和出射方向的遮蔽比例，与法线分布是相关的。

>介绍IBL

IBL是模拟了间接光，将环境光提前烘焙到cubemap，在运行时根据法线方向查询间接光的radiance。
对于漫反射的渲染方程经过简化和近似后，积分项就只有入射方向Radiance和入射方向余弦了，这部分可以提前计算，得到的是一个相比原图很模糊的结果。
对于镜面反射，可以根据积分近似拆成两项，一部分是入射方向Radiance的积分，可以预计算，这部分额外考虑了粗糙度，越粗糙采样的向量会越分散，因此需要生成mipmap。在shader中可以根据粗糙度映射到mipmap的level。
虽然镜面反射受到观察方向的影响，预计算无法得知，但是我们可以假设镜面反射的方向总是等于采样的方向。这会导致当视线趋近于掠射角时，预计算的结果就不是很准确了。
另一部分是BRDF和入射方向余弦的积分，考虑Cook-Torrance的镜面反射项BRDF，经过变形后BRDF只受到粗糙度和半程向量夹角余弦的影响。这部分也可以预计算。

>光线追踪和路径追踪的区别

光线追踪是一种渲染方式，路径追踪是光线追踪的一种实现方法。
理想的光线追踪是从屏幕出发每个像素发射一根，击中物体表面后根据表面材质再次反射更多光线，多次弹射后射线数量会爆炸式增长。
而路径追踪则是根据表面材质只采样一个方向继续弹射，直到光线击中光源或者逃逸停止。这是因为利用了蒙特卡洛方法，反射光线的采样会考虑法线分布，这样反射的光线都是贡献比较大的。最终的结果要除去pdf。为了避免一直反射，可以增加俄罗斯轮盘赌，在结果也要除去轮盘赌的pdf

>如何理解重要性采样

延迟渲染第一个pass中

>介绍下延迟渲染管线



>实时阴影