# 空间变换

## 概述

局部空间：物体空间，正交，可以是左右或右手系（意味着跟三角形裁剪相关，需调整），LocalToWorld包含旋转、缩放、平移等信息。缩放可能是负的，用于动画、风向等模拟。

切线空间：正交的（插值后会产生偏倚），可能是左手或右手系。TangentToLocal只包含旋转，不包含位置平移信息，因此是OrthoNormal（转置矩阵也是逆矩阵）。

世界空间：WorldToView矩阵仅包含旋转、平移，不包含缩放。

视图空间：相机空间，视图空间是一个以摄像机近裁剪面中心为原点的坐标空间。ViewToClip矩阵包含x，y缩放，但不包含平移。也可缩放和平移深度值z，通常还会应用投影矩阵变换到齐次投影空间。

裁剪空间：透视投影矩阵应用后，便可转换到齐次裁剪空间。需注意的是裁剪空间的W等同于视图空间的Z。

NDC空间，Clip空间的坐标应用透视除法后（xyz除以w分量），可获得屏幕空间的坐标。其中屏幕空间的横向坐标从左到右取值\[-1, 1]，竖向坐标从下到上取值\[-1, 1]，深度从近到远取值\[0, 1]（但OpenGL RHI的深度取值\[-1, 1]）。

视口空间，将屏幕坐标映射到窗口的像素坐标。横向坐标从左到右取值\[0, width-1]，竖向坐标从上到下取值\[0, height-1]（注意屏幕空间的竖向坐标从下到上递增）。

## 局部坐标系的构建

以给定向量n为局部空间Z轴，构建Z轴向上的局部坐标系。则在世界空间中，给定向量n若偏向于Y轴则映射到YZ平面，若偏向于X轴则映射到XZ平面。按照右手螺旋定则，我们可以在二维平面直接得到对应的垂直向量t，再使用n叉乘t得到s。

```cpp
Frame(const Vector3f& z) : n(z) {
    if (std::abs(n.x) > std::abs(n.y)) {
        t = Normalize(Vector3f(-n.z * invLen, 0.0f, n.x * invLen));
    } else {
        t = Normalize(Vector3f(0.0f, n.z * invLen, -n.y * invLen));
    }
    s = Cross(n, t);
}
```

对于要转换到局部空间的世界空间向量，需要进行stn矩阵变换。本质上就是计算世界空间向量在stn三个向量上的投影，等价于与stn分别进行点乘。

```cpp
Vector3f ToLocal(const Vector3f& v) const {
    return {Dot(v, s), Dot(v, t), Dot(v, n)};
}
```

对于要转换到世界空间的局部空间向量，则需要进行stn的逆变换。显然stn矩阵是一个正交矩阵，所以其逆矩阵等价于其转置矩阵。因此对局部空间变量进行stn矩阵逆变换等价于于stn分别相乘后再累加。

```cpp
Vector3f ToWorld(const Vector3f& v) const {
    return s * v.x + t * v.y + n * v.z;
}
```

## 切线空间

![1617944-20201026110740721-1912101149.jpg](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d797bd856caa40a782cc711775994c95~tplv-k3u1fbpfcp-watermark.image?)

TBN矩阵也是一个局部坐标系，是模型顶点根据切线和法线构造的正交的切线空间。设三角形边E1和E2。取三角形上一点的切线T与副切线B，映射到三维空间有以下关系：

$$
\begin{array}{l}
E_{1}=\Delta U_{1} T+\Delta V_{1} B 
\\\\
E_{2}=\Delta U_{2} T+\Delta V_{2} B
\end{array}
$$

其中的的Δu和Δv是顶点之间uv差值。
经过计算我们可以得到切线和副切线在三维空间中的映射：

$$
\begin{array}{l}
T=\frac{\Delta V_{1} E_{2}-\Delta V_{2} E_{1}}{\Delta V_{1} \Delta U_{2}-\Delta V_{2} \Delta U_{1}} 
\\\\
B=\frac{-\Delta U_{1} E_{2}+\Delta U_{2} E_{1}}{\Delta V_{1} \Delta U_{2}-\Delta V_{2} \Delta V_{1}}
\end{array}
$$

从模型中读取顶点的法线N，根据施密特正交化法则我们可以得到与法线N正交的切线。然后可以进一步正交化求出副切线或者直接叉乘得到副切线。施密特正交化的几何意义就是减去除了与之垂直的所有分量值，剩下的就只有垂直分量了

$$
\begin{array}{l}
T_{\perp}=\operatorname{Normalize}(T-(T \cdot N) * N)
\\\\
B_{\perp}=\operatorname{Normalize}(B-(B \cdot N) * N - (B \cdot T_{\perp})*T_{\perp} )
\\\\
B_{\perp}=N \times T_{\perp}
\end{array}
$$

### 法线贴图

法线贴图可以使得每个片元都有自己独特的法线，给物体表面营造出复杂的光照结果。
法线贴图的像素RGB值对应的是法线的XYZ值。法线贴图可以是存储世界空间法线，也可以是物体空间或者切线空间。
RGB的取值范围是\[0,1]，而世界空间法线的取值范围是\[-1,1]，需要做重映射

$$
RGB = \frac{XYZ+1}{2}
$$

模型空间法线的问题是如果该法线所在三角形发生变化时法线就不再正确。
而且切线空间法线则是每个顶点的相对法线信息。因此在切线空间中法线的Z方向总是正方向的，可以只存储XY值，根据勾股定理求出Z值。对于正方体，其六个面可以公用一张法线贴图。也正因此，切线空间法线贴图是偏蓝紫色的，因为法线大都是偏向Z轴即(0,0,1)的。

## 线性变换

### 旋转变换

对于二维平面上以O为圆心、半径为1的单位圆，已知圆上任意一点$A(x_1,y_1)$。设OA与x轴夹角为a，其坐标为$A(\cos{a}，\sin{a})$。再取圆上任意一点B(x2,y2)，它是A点沿圆旋转b°后得到的。则OB与x轴夹角为a+b，其坐标为B(cos(a+b)，sin(a+b))。

由三角函数公式可得：

$$
\cos{(a+b)}=\cos{a} \cdot \cos{b}-\sin{a} \cdot \sin{b}
\\\\
\sin{(a+b)}=\sin{a} \cdot \cos{b}+\cos{a} \cdot \sin{b}
$$

由于A点坐标是已知的，带入A(x1,y1)可得线性方程组，可转为矩阵形式。

$$
x_2=\cos{b} \cdot x_1 - \sin{b} \cdot y_1
\\\\
y_2=\sin{b} \cdot x_1 + \cos{b} \cdot y_1
$$

$$
\begin{bmatrix}  
  x_2 \\  
  y_2   
\end{bmatrix} 
=
\begin{bmatrix}  
  \cos{b} & -\sin{b} \\  
  \sin{b} & \cos{b}  
\end{bmatrix} 
\cdot
\begin{bmatrix}  
  x_1 \\  
  y_1   
\end{bmatrix} 
$$

三维的绕XYZ轴旋转实际上就是固定了一轴的二维旋转，因此推广到三维空间后，被绕的轴为单位向量，其他轴上的该维度分量为0。按照叉乘的方向为旋转的方向，其中绕Y轴旋转是从Z轴旋转到X轴。映射时需要注意此时Z-3D轴映射到了X-2D轴，X-3D轴映射到了Y-2D，所以绕Y轴旋转矩阵看起来时调换了符号。

$$
\left[
\begin{array}{ccc}
1 & 0 & 0 \\
0 & \cos \alpha & -\sin \alpha\\
0 & \sin \alpha & \cos \alpha 
\end{array}\right]
,
\left[\begin{array}{ccc}
\cos \alpha & 0 & \sin \alpha\\
0 & 1 & 0  \\
-\sin \alpha & 0 & \cos \alpha
\end{array}\right]
,
\left[\begin{array}{ccc}
\cos \alpha & -\sin \alpha & 0  \\
\sin \alpha & \cos \alpha & 0  \\
0 & 0 & 1 
\end{array}\right]
$$

#### 万向死锁

#### 四元数

## 齐次空间坐标

为了处理平移变换，将旋转和平移合并为4x4的矩阵，三维向量$(x,y,z)$也需要增加一个维度$(x,y,z,w)$。

$$
\left[\begin{array}{llll}
1 & 0 & 0 & 1 \\
0 & 1 & 0 & 1 \\
0 & 0 & 1 & 1 \\
0 & 0 & 0 & 1
\end{array}\right]\left[\begin{array}{l}
2 \\
3 \\
4 \\
1
\end{array}\right]=\left[\begin{array}{l}
3 \\
4 \\
5 \\
1
\end{array}\right]
$$

## 相机变换

设定摄像机位置为 $e$ ，垂直向上的向量为 $t$ ，观察方向为 $g$ 。则世界空间坐标变换到相机空间则需要做和相机相反的位移。

$$
\left[\begin{array}{cccc}
1 & 0 & 0 & -x_{e} \\
0 & 1 & 0 & -y_{e} \\
0 & 0 & 1 & -z_{e} \\
0 & 0 & 0 & 1
\end{array}\right]
$$

在右手坐标系中，我们约定相机看向世界空间的 $- z$ 轴，并构建正交坐标系，得到 $g \times t$。据此可以直接写出变换矩阵为

$$
\left[\begin{array}{cccc}
x_{\hat{g} \times \hat{t}} & x_{t} & x_{-g} & 0 \\
y_{\hat{g} \times \hat{t}} & y_{t} & y_{-g} & 0 \\
z_{\hat{g} \times \hat{t}} & z_{t} & z_{-g} & 0 \\
0 & 0 & 0 & 1 
\end{array}\right]
$$

对于世界空间坐标，其需要做逆变换，而旋转变换是正交变换，其逆矩阵就等于其转置矩阵，因此可以直接得出相机变换的旋转矩阵。

$$
\left[\begin{array}{cccc}
x_{g \times t} & y_{g \times t} & z_{g \times t} & 0 \\
x_{t} & y_{t} & z_{t} & 0 \\
x_{-g} & y_{-g} & z_{-g} & 0 \\
0 & 0 & 0 & 1
\end{array}\right]
$$

最终完整的观察矩阵可以化简为

$$
\left[\begin{array}{cccc}
x_{g \times t} & y_{g \times t} & z_{g \times t} & -e \cdot {(g \times t)} \\
x_{t} & y_{t} & z_{t} & -e \cdot \ t \\
x_{-g} & y_{-g} & z_{-g} & -e \cdot g \\
0 & 0 & 0 & 1
\end{array}\right]
$$

## 投影变换

### 正交投影变换

View Space 在对称情形下，$r$ 和 $l$ ，$t$ 和 $b$ 可以相互抵消，并且实际上一般都是对称的。

正交投影变换可以分解为位移变换和缩放变换。首先进行位移变换，将 View Space 移动到观察空间的坐标系原点。然后再进行缩放变换，将 View Space 的长宽高变换为 $[-1,1]$ 的范围，即标准立方体。此时称为齐次裁剪空间。经过齐次裁剪，再对坐标进行透视除法，才变换到 NDC 空间。

$$
\left[\begin{array}{cccc}
\frac{2}{r-l} & 0 & 0 & 0 \\
0 & \frac{2}{t-b} & 0 & 0 \\
0 & 0 & \frac{2}{f-n} & 0 \\
0 & 0 & 0 & 1
\end{array}\right]
\left[\begin{array}{cccc}
1 & 0 & 0 & -\frac{r+l}{2} \\
0 & 1 & 0 & -\frac{t+b}{2} \\
0 & 0 & 1 & -\frac{f+n}{2} \\
0 & 0 & 0 & 1
\end{array}\right]
=
\left[\begin{array}{cccc}
\frac{2}{r-l} & 0 & 0 & -\frac{r+l}{r-l} \\
0 & \frac{2}{t-b} & 0 & -\frac{t+b}{t-b} \\
0 & 0 & \frac{2}{f-n} & -\frac{f+n}{f-n} \\
0 & 0 & 0 & 1
\end{array}\right]
$$

$$
\left[\begin{array}{cccc}
\frac{1}{r} & 0 & 0 & 0 \\
0 & \frac{1}{t} & 0 & 0 \\
0 & 0 & \frac{2}{f-n} & 0 \\
0 & 0 & 0 & 1
\end{array}\right]
\left[\begin{array}{cccc}
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & 1 & -\frac{f+n}{2} \\
0 & 0 & 0 & 1
\end{array}\right]
=
\left[\begin{array}{cccc}
\frac{1}{r} & 0 & 0 & 0 \\
0 & \frac{1}{t} & 0 & 0 \\
0 & 0 & \frac{2}{f-n} & -\frac{f+n}{f-n} \\
0 & 0& 0 & 1
\end{array}\right]
$$

### 透视投影变换

透视投影变换需要先将截锥体形状的 View Space 挤压成长方体形状的的 View Space 后，再进行正交投影变换。将该矩阵和正交投影矩阵左乘后即可得到完整的透视投影矩阵。

$$
M_{persp \rightarrow ortho}
=
\left(\begin{array}{cccc}
n & 0 & 0 & 0 \\
0 & n & 0 & 0 \\
0 & 0 & -(n+f) & -nf\\
0 & 0 & 1 & 0
\end{array}\right)
$$

$$
M_{persp} 
=
\left(\begin{array}{cccc}
\frac{2 n}{r-l} & 0 & -\frac{r+l}{r-l} & 0 \\
0 & \frac{2 n}{t-b} & -\frac{t+b}{t-b} & 0 \\
0 & 0 & -\frac{f+n}{f-n} & -\frac{2 f n}{f-n} \\
0 & 0 & -1 & 0
\end{array}\right)
=
\left(\begin{array}{cccc}
\frac{n}{r} & 0 & 0 & 0 \\
0 & \frac{n}{t} & 0 & 0 \\
0 & 0 & -\frac{f+n}{f-n} & -\frac{2 f n}{f-n} \\
0 & 0 & -1 & 0
\end{array}\right)
$$

三维向量$(x,y,z)$中的z分量代表了该坐标与相机的距离。在透视投影中物体是近大远小的，这意味着离相机越远即z分量越大，显得越小。即与1/z正相关。通过如下形式的4x4矩阵，我们可以将坐标的z分量保存到投影后的齐次坐标w中，因此w的几何含义就是投影的距离，当w增大时，坐标被拉伸，w减小时，坐标被压缩。w对三维坐标起到缩放的作用。远处的坐标的w也就是变换前的z是更大的，被压缩的更多，也就符合我们的近大远小的需求。

$$
\left[\begin{array}{llll}
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & 1 & 0 \\
0 & 0 & 1 & 0
\end{array}\right]\left[\begin{array}{l}
2 \\
3 \\
4 \\
1
\end{array}\right]=\left[\begin{array}{l}
2 \\
3 \\
4 \\
4
\end{array}\right]
$$

### 齐次裁剪空间

齐次空间裁剪（Homogeneous Clipping Space）可以更细粒度地将视锥体外的三角形剔除，将视锥体上的三角形裁剪为新三角形。但裁剪新三角形的操作是比较麻烦的事情，在光栅化时通过视口和平面方程来裁剪超出屏幕范围的部分会更容易。

对于坐标点$(x,y,z,1)$，假设经过透视投影变换后为$(x',y',z',w')$，其中$w'=z_{view}$。
如果有顶点在近平面后，则导致w'<0，进行透视除法时会使得其xy坐标翻转，

透视除法变换到$[-1,1]×[-1,1]×[0,1]$的NDC空间$(\frac{x'}{w},\frac{y'}{w},\frac{z'}{w})$。则在透视除法前有
$$
\left\{\begin{matrix} 
-w<x'<w\\\\
-w<y'<w\\\\
0<z'<w
\end{matrix}\right. 
$$

不符合以上条件的顶点在视景体外。将z<0的顶点剔除掉

w 平面裁剪是一个特殊过程，必须在 /w 之前的四维空间下进行裁剪，保证所有顶点的 w > 0，后面归一化 / w 时也才不会除零错误。
把 w=0 平面往前推进那么一点点，0变成很小的近似0的E，要取的比较小，但又不能太小
整个 cvv 的包围平面( z > 0, z < w, x > -w, x < w ...) 给裁剪完，或者简单点，可以先归一化 / w了，然后用 \[-1, 1] 裁剪。

### NDC空间

#### 透视除法

## 视口变换

设定近平面和远平面的数值 $n,f $ 为正数。取垂直视场角 $fov$ 的一半做正切，即最高参数 $t$ 与最近参数 $n$ 的比值。再通过屏幕宽高比即可得出最右参数 $r$ 。

$$
\tan{\frac{fov}{2}} = \frac{t}{n}
\\
\\
r = t \times \frac{w}{h}
$$

# Z-Fighting

场景中较远处物体有时会出现闪烁的现象，而在近处很少会出
现。如果使用正交投影则会极大解决这一现象。
观察投影矩阵，我们可以得知相机空间和裁剪空间的关系，例如$w_{c} = z$。相机空间坐标的z经过透视投影变换后，被存在齐次裁剪空间坐标的w中。经过透视除法后我们可以得到NDC空间的深度。

$$
\left[
\begin{array}{c}
\cdot \\
\cdot \\
z_{c} \\
w_{c}
\end{array}\right]=\left[\begin{array}{llll}
\cdot & & & \\
& \cdot & & \\
& b & a \\
& 1 &
\end{array}\right]\left[\begin{array}{l}
\cdot \\
\cdot \\
z \\
1
\end{array}\right]
$$

观察这个关系式，我们可以看出NDC空间坐标的深度，也就是屏幕空间的深度，是与相机空间坐标的z成反比的。使用4bit的整形深度缓冲区记录0-1的深度，即0-1内有4x4=16个均匀的间隔。以此为y轴，相机空间深度为x轴，画出1/z函数的抛物线。观察抛物线，我们可以看出从near到far的一小段距离就占据了0-1的大部分区间。

$$
\begin{aligned}
d 
& = \frac{z_{c}}{w_{c}}
& = \frac{a+b z}{z} 
& = a \frac{1}{z}+b
\end{aligned}
$$

我们可以看出影响精度一个要素是近平面near的数值如果过小，会使得精度迅速下降。因此我们可以调整near的取值，使得near不要过小但又不影响视觉效果，在一个较为平衡的数值下可以减缓1/z抛物线的快速下降。

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ca2dd712e953411c833ca7dccc6c0c76~tplv-k3u1fbpfcp-watermark.image?)

## Reverse-Z

如果将深度缓冲区换成3个指数位3个尾数位的模拟浮点数格式，可以看出浮点数是在靠近0的方向更加精准，这无疑是加剧了这一问题。

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aa6872c510b24efa9ba492cd56773828~tplv-k3u1fbpfcp-watermark.image?)

因此我们可以将深度值从0-1反转为1-0，使得浮点数的精度更多地分布在远处。这样浮点数的精度在一定程度上低效了1/z的非线性影响。现在远处的精度是足够的，只是精度的变化会非常缓慢。
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b2d8984977e54fc2a0e75478b9bebfe2~tplv-k3u1fbpfcp-watermark.image?)

### 不同API下的深度范围

\[0,1]是D3D的约定，对于OpenGL，其深度是\[-1,1]。这是因为二者的NDC空间的定义不同。OpenGL默认深度范围是\[-1,1]，这导致精度集中在0附近，映射到相机空间坐标z值上体现为只有近处某一小段距离是高精度的。即使你将深度再映射到0-1。

## 结论

根据对减少精度误差的几种方式的测试结果，可以得出以下结论：

*   float32浮点数和int24整数的深度缓冲区之间没有太大区别，但是使用float32+reverse-z的方式确实是最精确的。float32有23位的尾数，
*   分离视图和投影矩阵在许多情况下是有用处的
*   无限远平面的影响微乎其微。
*   reverse-z的作用极其明显，使用reverse-z你可以任意组合投影矩阵和任意的远平面。
    为什么浮点数在0附近精度更高？

# 画线算法

##