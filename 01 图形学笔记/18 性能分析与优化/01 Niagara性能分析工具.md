# Niagara 性能分析工具
## 静态性能分析
静态分析工具以插件的形式提供，主要通过继承静态函数扩展类，把分析调用的接口暴露给蓝图或者脚本。同 py 脚本设置为启动引擎自动执行，将结果保存在 json 中，接入腾讯的自动化流水线。
引擎组为美术提供一些资产制作规范以及母材质，溶解遮罩等
例如
纹理大小原则上不能超过 515 x 512
纹理的个数不能超过 6 张
如果资产使用了过多的母材质提供的功能，回迅速带来采样个数和 gpu 指令数的增加

粒子发射器的个数不超过 15 个

粒子的发射个数在 pc 端不超过 100，移动端不超过25

使用 mesh renderer 的 mesh 使用高模有很大的性能开销。
如果是透明的材质，renderer 的面积过大会造成严重的 overdraw

## 动态性能分析

需求：想要对美术制作的 Niagara 资产进行规范和针对性优化
痛点：insight，包括市面上的性能分析工具只能评估整体的性能消耗，无法做到粒子发射器粒度的性能统计。
解决：通过对 insight 的改造，将数据到处，再进行二次分析，对于每个 niagara 的粒子发射器在运行时的总开销进行统计和排行。得到了生命周期中总开销最大的粒子发射器，我们就可以快速定位，让美术去调整去优化。



首先我们通过 Unreal Insight 分析 Niagara 在 CPU 和 GPU 上的耗时
发现在 GameThread 主要是在第一次初始化 Niagara 是会耗费较多时间
在渲染线程，Niagara 资产名就是 timeline 上的节点名

对于第二点，我们希望能统计所有 Niagara 的特定场景中的总耗时
动态性能分析需要修改 UE 的 Insight 源码。在打开 utrace 文件时，insight 会另起一个线程以解析文件，定位到相关代码后，出找出感兴趣的数据以特定的格式保存起来。
这些数据是按照 timeline 排列的，类似一个树形结构，我们只保留构建 timeline 必须的进出时间和 id。然后使用 py 脚本解析这些数据，重建 timeline 的数据结构，找到 Niagara 相关的部分，在数据中统计这些数据，这样就得到了场景中的特效在一段时间内的时间开销。